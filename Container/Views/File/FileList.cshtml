@{
    Layout = null;
}

<table class="table">
    @foreach (Container.Dto.Archivo_s3_ResponseDto c in ViewBag.files)
    {
        <tr>
            <td>
                <div id="@c.id">
                    @c.nombre
                </div>
            </td>
        </tr>
    }

</table>
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#UploadModal">
    Nuevo
</button>

<div class="modal fade" id="UploadModal" tabindex="-1" role="dialog" aria-labelledby="upload" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="upload">Carga de un nuevo archivo a @ViewBag.repoName</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="/File/UploadFile" enctype="multipart/form-data" method="post" id="frmFile">
                    <h3>Seleccione el archivo</h3>
                    <input type="file" name="file" id="file"/>
                    <div id="errMessage" class="alert alert-danger my-2" role="alert">Este campo no puede estar vacio</div>
                    <div class="progress my-2" style="display:none;" id="progressBar">
                        <div class="progress-bar progress-bar-animated progress-bar-striped active" role="progressbar"
                             aria-valuemin="0" aria-valuemax="100" style="width:0%">
                            0%
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="nuevoAr" >Subir archivo</button>
            </div>
        </div>
    </div>
</div>

<script>
    
    $('#nuevoAr').on("click", function () {
        if ($('#file').get(0).files.length === 0) {
            $('#errMessage').show()
        } else {
            $('#errMessage').hide()
            $('#progressBar').show()
            fileuploaddata = new FormData($('#frmFile')[0])
            fileuploaddata.append('repo_id',@ViewBag.repo)
            $.ajax({
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();

                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);
                            $('.progress-bar').width(percentComplete + '%');
                            $('.progress-bar').html(percentComplete + '%');
                        }
                    }, false);

                    return xhr;
                },
                url: '/File/UploadFile',
                type: "POST",
                data: fileuploaddata,
                processData: false,
                contentType: false,
                dataType: "json"
            }).done(function (response) {
                if (response == true) {
                    $('#UploadModal').modal('hide')
                    swal({
                        title: "Completado",
                        text: "La operacion ha sido completada",
                        icon: "success",
                        button: "Ok"
                    })
                } else {
                    $('#UploadModal').modal('hide')
                    swal({
                        title: "Error al procesar el archivo",
                        text: "La operacion no se pudo realizar",
                        icon: "error",
                        button: "Ok"
                    })
                }
                
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert(jqXHR.responseText)
                swal({
                    title: "Error al cargar la página",
                    text: "La operacion no se pudo realizar",
                    icon: "error",
                    button: "Ok"
                })
            })           
        }        
    })

    $('#UploadModal').on('show.bs.modal', function (e) {
        $('#progressBar').hide()
        $('#errMessage').hide()
    })

    $('#UploadModal').on('hidden.bs.modal', function (e) {
        $('#frmFile')[0].reset();
    })
</script>